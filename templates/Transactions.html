{% extends "base.html" %}

{% block body %}
<div class="container">
    <div class="card mb-4">
        <div class="card-body d-flex align-items-center">
            <span class="me-3">Time Period:</span>
            <div class="btn-group" role="group">
                <a href="{{ url_for('transactions') }}" class="btn {% if activePeriod == 'all' %}btn-primary{% else %}btn-outline-secondary{% endif %}">All</a>
                <a href="{{ url_for('transactions', periodFilter='today') }}" class="btn {% if activePeriod == 'today' %}btn-primary{% else %}btn-outline-secondary{% endif %}">Today</a>
                <a href="{{ url_for('transactions', periodFilter='week') }}" class="btn {% if activePeriod == 'week' %}btn-primary{% else %}btn-outline-secondary{% endif %}">Week</a>
                <a href="{{ url_for('transactions', periodFilter='month') }}" class="btn {% if activePeriod == 'month' %}btn-primary{% else %}btn-outline-secondary{% endif %}">Month</a>
                <a href="{{ url_for('transactions', periodFilter='year') }}" class="btn {% if activePeriod == 'year' %}btn-primary{% else %}btn-outline-secondary{% endif %}">Year</a>
            </div>
        </div>
    </div>

    <div class="row text-center mb-5">
        <h2 class="mb-4">Your Financial Summary</h2>
        <div class="col-md-4">
            <div class="card text-white bg-success">
                <div class="card-header">Total Income</div>
                <div class="card-body">
                    <h4 class="card-title">{{ "%.2f"|format(totalIncome) }}</h4>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-danger">
                <div class="card-header">Total Expenses</div>
                <div class="card-body">
                    <h4 class="card-title">{{ "%.2f"|format(totalExpense) }}</h4>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card text-white bg-info">
                <div class="card-header">Balance</div>
                <div class="card-body">
                    <h4 class="card-title">{{ "%.2f"|format(balance) }}</h4>
                </div>
            </div>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-md-8">
            <h2 class="mb-4">Add New Transaction</h2>
            <form method="POST" action="{{ url_for('transactions') }}">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="transactionType" class="form-label">Transaction Type</label>
                        <select class="form-select" name="transactionType" id="transactionType" required>
                            <option value="expense">Expense</option>
                            <option value="income">Income</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="amount" class="form-label">Amount</label>
                        <input type="number" step="10" name="amount" id="amount" class="form-control" required placeholder="0.00">
                    </div>
                </div>
                <div class="mb-3">
                    <label for="description" class="form-label">Description</label>
                    <input type="text" name="description" id="description" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label for="category" class="form-label">Category</label>
                    <select class="form-select" name="category" id="category" required>
                        <option value="" disabled selected>Select a category...</option>
                        <option value="food">Food & Groceries</option>
                        <option value="transport">Transport</option>
                        <option value="entertainment">Entertainment</option>
                        <option value="housing">Housing & Utilities</option>
                        <option value="health">Health</option>
                        <option value="salary">Salary</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="date" class="form-label">Date</label>
                        <input type="date" name="date" id="date" class="form-control" value="{{ currentUser.get('date', '') }}" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="time" class="form-label">Time</label>
                        <input type="time" class="form-control" name="time" id="time" list="time-options" value="{{ currentUser.get('time', '') }}" required>
                        <datalist id="time-options">
                            {% for h in range(24) %}
                                <option value="{{ '%02d:00'|format(h) }}">
                                <option value="{{ '%02d:30'|format(h) }}">
                            {% endfor %}
                        </datalist>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary w-100">Add Transaction</button>
            </form>
        </div>
    </div>

    <hr class="my-5">

    <div class="row justify-content-center">
        <div class="col-md-8">
            <h2 class="mb-4">Transaction History</h2>

            <form method="GET" action="{{ url_for('transactions') }}" class="mb-4 p-3 border rounded bg-light">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label for="textFilter" class="form-label">Search by description</label>
                        <input type="text" name="textFilter" id="textFilter" class="form-control" placeholder="e.g. 'Taxi'" value="{{ textFilter }}">
                    </div>
                    <div class="col-md-3">
                        <label for="categoryFilter" class="form-label">Category</label>
                        <select name="categoryFilter" id="categoryFilter" class="form-select">
                            <option value="" {% if not categoryFilter %}selected{% endif %}>All Categories</option>
                            <option value="food" {% if categoryFilter == 'food' %}selected{% endif %}>Food & Groceries</option>
                            <option value="transport" {% if categoryFilter == 'transport' %}selected{% endif %}>Transport</option>
                            <option value="entertainment" {% if categoryFilter == 'entertainment' %}selected{% endif %}>Entertainment</option>
                            <option value="housing" {% if categoryFilter == 'housing' %}selected{% endif %}>Housing & Utilities</option>
                            <option value="health" {% if categoryFilter == 'health' %}selected{% endif %}>Health</option>
                            <option value="salary" {% if categoryFilter == 'salary' %}selected{% endif %}>Salary</option>
                            <option value="other" {% if categoryFilter == 'other' %}selected{% endif %}>Other</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="typeFilter" class="form-label">Type</label>
                        <select name="typeFilter" id="typeFilter" class="form-select">
                            <option value="" {% if not typeFilter %}selected{% endif %}>All Types</option>
                            <option value="income" {% if typeFilter == 'income' %}selected{% endif %}>Income</option>
                            <option value="expense" {% if typeFilter == 'expense' %}selected{% endif %}>Expense</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="dateFilter" class="form-label">Date</label>
                        <input type="date" name="dateFilter" id="dateFilter" class="form-control" value="{{ dateFilter }}">
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">Search</button>
                    </div>
                </div>
            </form>

            <div id="transactions-list">
                {% if transactions %}
                    {% for t in transactions %}
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                {% if t.transactionType == 'income' %}
                                    <div class="me-3 fs-4 text-success">+</div>
                                {% else %}
                                    <div class="me-3 fs-4 text-danger">-</div>
                                {% endif %}
                    
                                <div class="flex-grow-1">
                                    <h5 class="mb-1">
                                        {{ t.description }}
                                        <span class="badge bg-secondary fw-normal">{{ t.category }}</span>
                                    </h5>
                                    <p class="card-text mb-0">
                                        <small class="text-muted">üóìÔ∏è {{ t.date }} &nbsp; üïí {{ t.time }}</small>
                                    </p>
                                </div>
                    
                                <div class="d-flex align-items-center">
                                    <h4 class="me-3 mb-0 {% if t.moneyAmount < 0 %}text-danger{% else %}text-success{% endif %}">
                                        {% if t.moneyAmount > 0 %}+{% endif %}{{ "%.2f"|format(t.moneyAmount) }}
                                    </h4>
                                    <form method="POST" action="{{ url_for('deleteTransaction', transactionId=t._id) }}" onsubmit="return confirm('Are you sure you want to delete this transaction?');">
                                        <button type="submit" class="btn btn-outline-danger btn-sm">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash3" viewBox="0 0 16 16">
                                                <path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5ZM11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H2.506a.58.58 0 0 0-.01 0H1.5a.5.5 0 0 0 0 1h.538l.853 10.66A2 2 0 0 0 4.885 16h6.23a2 2 0 0 0 1.994-1.84l.853-10.66h.538a.5.5 0 0 0 0-1h-.995a.59.59 0 0 0-.01 0H11Zm-6.465 1h9.93l-.86-10.75h-8.21l-.86 10.75ZM4.5 5.038a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0Zm2.5 0a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0Zm2.5 0a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0Z"/>
                                            </svg>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-center">No transactions found.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}